<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZairuDuo Studio ğŸ™ï¸</title>
    <style>
        body { background: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
        .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }

        input, select, button, textarea { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #222; color: white; margin: 5px 0; font-size: 14px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .box { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .section-title { margin: 0 0 10px 0; font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { background: #333; color: #aaa; flex: 1; border-bottom: 2px solid transparent; border-radius: 6px 6px 0 0; }
        .tab-btn.active { background: #1d9bf0; color: white; border-bottom: 2px solid white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .btn-add { background: linear-gradient(45deg, #1d9bf0, #00ba7c); }
        .btn-control { background: #333; border: 1px solid #555; }
        .btn-active-auto { background: #00ba7c; color: white; animation: pulse 2s infinite; }
        
        /* ğŸ”¥ ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ğŸ”¥ */
        .queue-card { 
            background: #1e1e1e; 
            border: 1px solid #333;
            border-right: 4px solid #444; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
            transition: all 0.2s;
        }
        .queue-card.active { border-right-color: #1d9bf0; background: #222b33; border-color: #1d9bf0; box-shadow: 0 0 10px rgba(29, 155, 240, 0.1); }
        .queue-card.pinned { border-right-color: #e6b800; }
        .queue-card.breaking { border-right-color: #f91880; }

        /* Ø§Ù„ØµÙ Ø§Ù„Ø¹Ù„ÙˆÙŠ: ØªØ±ØªÙŠØ¨ + Ø¹Ù†ÙˆØ§Ù† + Ø£Ø¯ÙˆØ§Øª */
        .card-top { 
            display: flex; align-items: center; justify-content: space-between; 
            background: rgba(0,0,0,0.2); padding: 6px 10px; border-bottom: 1px solid #333;
        }
        .card-index { font-weight: bold; font-size: 12px; color: #666; width: 25px; }
        .card-title { font-weight: bold; font-size: 13px; color: #fff; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-badges { font-size: 12px; margin-right: 5px; }

        /* Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆØ³Ø·: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ØµÙŠ */
        .card-body { 
            padding: 8px 10px; 
            font-size: 13px; 
            color: #ccc; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* Ø§Ù„ØµÙ Ø§Ù„Ø³ÙÙ„ÙŠ: Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .card-actions { 
            display: flex; gap: 2px; padding: 5px; background: rgba(0,0,0,0.1); 
        }
        .action-btn { 
            flex: 1; padding: 6px 0; font-size: 14px; border-radius: 4px; background: #2a2a2a; color: #aaa; 
            display: flex; justify-content: center; align-items: center;
        }
        .action-btn:hover { background: #3a3a3a; color: white; }
        .btn-play { background: #1d9bf0; color: white; flex: 2; }
        .btn-play:hover { background: #1a8cd8; }
        .btn-delete { background: #3a1111; color: #ff6666; }
        .btn-delete:hover { background: #5a1111; }

        .preview-container { width: 100%; height: 168px; overflow: hidden; position: relative; background: #000; border-radius: 8px; border: 2px solid #333; }
        iframe { width: 1280px; height: 720px; border: none; transform: scale(0.234); transform-origin: top left; pointer-events: none; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        #editModalContent { background: #222; padding: 20px; border-radius: 10px; width: 400px; border: 1px solid #444; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="main-grid">
    <div>
        <div class="box" style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
            <div><span id="statusIcon">âšª</span> <span id="statusText">...</span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <label style="font-size:12px;"><input type="checkbox" id="playSound" onchange="updateSettings()" style="width:auto;"> ğŸ”Š</label>
                <input type="number" id="globalTimer" value="15" style="width:50px; text-align:center; padding:5px;" onchange="updateSettings()" title="Ø§Ù„Ù…Ø¤Ù‚Øª">
            </div>
        </div>

        <div class="box" style="border-top: 3px solid #1d9bf0;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('link')">ğŸ”— Ø±Ø§Ø¨Ø·</button>
                <button class="tab-btn" onclick="switchTab('custom')">âœï¸ Ù…Ø®ØµØµ</button>
            </div>
            <div id="tab-link" class="tab-content active">
                <input type="text" id="tweetUrl" placeholder="https://x.com/..." autofocus>
            </div>
            <div id="tab-custom" class="tab-content">
                <input type="text" id="customTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨)">
                <textarea id="customText" rows="2" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
                <input type="text" id="customImage" placeholder="ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <input type="text" id="customMedia" placeholder="ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø±/Ù…ÙŠØ¯ÙŠØ§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <select id="addTheme" style="flex:1;">
                    <option value="classic">ÙƒÙ„Ø§Ø³ÙŠÙƒ</option>
                    <option value="minimal">Ù…ÙŠØªØ§Ù„ (Minimal)</option>
                    <option value="chunky">Ø¶Ø®Ù… (Chunky)</option>
                    <option value="bubble">ÙÙ‚Ø§Ø¹Ø©</option>
                </select>
                <input type="number" id="addDuration" placeholder="Ø«ÙˆØ§Ù†ÙŠ" style="width:60px; text-align:center;">
            </div>
            <button class="btn-add" onclick="addItem()">Ø¥Ø¶Ø§ÙØ© â•</button>
        </div>

        <h3 class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© (<span id="count">0</span>)</h3>
        <div id="queueList"></div>
    </div>

    <div>
        <div class="box">
            <h4 class="section-title">ğŸ‘ï¸ Live Preview</h4>
            <div class="preview-container"><iframe src="/overlay.html" scrolling="no"></iframe></div>
        </div>
        <div class="box">
            <h4 class="section-title">ğŸ® ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨Ø«</h4>
            <div style="display:flex; gap:5px;">
                <button class="btn-control" onclick="api('control', {action:'prev'})">â®ï¸</button>
                <button class="btn-control" onclick="api('control', {action:'next'})">â­ï¸</button>
            </div>
            <button id="btnAuto" class="btn-control" style="width:100%; margin-top:5px;" onclick="api('control', {action:'toggle_auto'})">ØªÙ„Ù‚Ø§Ø¦ÙŠ â¯ï¸</button>
            <button class="btn-control" style="width:100%; margin-top:5px; background:#f91880; color:white;" onclick="api('control', {action:'hide'})">Ø¥Ø®ÙØ§Ø¡ â¹ï¸</button>
        </div>
        <div class="box">
            <h4 class="section-title">âš™ï¸ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù†Ø§ØµØ±</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <label><input type="checkbox" id="showAvatar" onchange="updateSettings()" style="width:auto;"> ØµÙˆØ±Ø©</label>
                <label><input type="checkbox" id="showName" onchange="updateSettings()" style="width:auto;"> Ø§Ø³Ù…</label>
                <label><input type="checkbox" id="showMedia" onchange="updateSettings()" style="width:auto;"> Ù…ÙŠØ¯ÙŠØ§</label>
                <label><input type="checkbox" id="showDate" onchange="updateSettings()" style="width:auto;"> ØªØ§Ø±ÙŠØ®</label>
            </div>
        </div>
    </div>
</div>

<div id="editModal">
    <div id="editModalContent">
        <h3 style="margin-top:0;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±</h3>
        <input type="hidden" id="editIndex">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label><input type="text" id="editTitle">
        <label>Ø§Ù„Ù†Øµ:</label><textarea id="editText" rows="4"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="saveEdit()" style="background:#1d9bf0;">Ø­ÙØ¸</button>
            <button onclick="closeEdit()" style="background:#555;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let currentMode = 'link';

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchTab('${mode}')"]`).classList.add('active');
        document.getElementById(`tab-${mode}`).classList.add('active');
    }

    socket.on('state_update', (state) => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
        document.getElementById('count').innerText = state.queue.length;
        document.getElementById('statusText').innerText = state.isAuto ? "Auto" : "Manual";
        document.getElementById('statusIcon').innerText = state.isAuto ? "ğŸŸ¢" : "â¸ï¸";
        const btnAuto = document.getElementById('btnAuto');
        if(state.isAuto) btnAuto.classList.add('btn-active-auto'); else btnAuto.classList.remove('btn-active-auto');

        if(state.settings) {
            document.getElementById('showAvatar').checked = state.settings.showAvatar;
            document.getElementById('showName').checked = state.settings.showName;
            document.getElementById('showMedia').checked = state.settings.showMedia;
            document.getElementById('showDate').checked = state.settings.showDate;
            document.getElementById('playSound').checked = state.settings.playSound;
            document.getElementById('globalTimer').value = state.settings.defaultDuration || 15;
        }

        // Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        const list = document.getElementById('queueList');
        list.innerHTML = '';
        state.queue.forEach((t, i) => {
            const div = document.createElement('div');
            const isPinned = t.customSettings?.pinned;
            const isBreaking = t.customSettings?.breaking;
            
            div.className = `queue-card ${i === state.current ? 'active' : ''} ${isPinned ? 'pinned' : ''} ${isBreaking ? 'breaking' : ''}`;
            
            const displayTitle = t.user.name;
            const displayText = t.text || 'Ù…ÙŠØ¯ÙŠØ§';

            div.innerHTML = `
                <div class="card-top">
                    <span class="card-index">#${i+1}</span>
                    <span class="card-title">${displayTitle}</span>
                    <span class="card-badges">
                        ${isPinned ? 'ğŸ“Œ' : ''} ${isBreaking ? 'ğŸš¨' : ''}
                    </span>
                    <div>
                        <button class="mini-btn" style="background:none; border:none; color:#888;" onclick="api('manage', {action:'move_up', index:${i}})">â¬†ï¸</button>
                        <button class="mini-btn" style="background:none; border:none; color:#888;" onclick="api('manage', {action:'move_down', index:${i}})">â¬‡ï¸</button>
                    </div>
                </div>
                
                <div class="card-body" title="${displayText}">${displayText}</div>
                
                <div class="card-actions">
                    <button class="action-btn btn-play" onclick="api('control', {action:'show', index:${i}})">ØªØ´ØºÙŠÙ„ â–¶ï¸</button>
                    <button class="action-btn" onclick="openEdit(${i}, '${displayTitle.replace(/'/g, "\\'")}', '${displayText.replace(/'/g, "\\'").replace(/\n/g, ' ')}')" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                    <button class="action-btn" style="color:${isPinned?'#e6b800':'#aaa'}" onclick="editItem(${i}, 'togglePin', true)" title="ØªØ«Ø¨ÙŠØª">ğŸ“Œ</button>
                    <button class="action-btn" style="color:${isBreaking?'#f91880':'#aaa'}" onclick="editItem(${i}, 'toggleBreaking', true)" title="Ø¹Ø§Ø¬Ù„">ğŸš¨</button>
                    <button class="action-btn btn-delete" onclick="api('manage', {action:'delete', index:${i}})">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(div);
        });
    });

    function addItem() {
        const theme = document.getElementById('addTheme').value;
        const duration = document.getElementById('addDuration').value;
        let payload = { mode: currentMode, theme, duration };

        if (currentMode === 'link') {
            payload.url = document.getElementById('tweetUrl').value;
        } else {
            payload.title = document.getElementById('customTitle').value;
            payload.text = document.getElementById('customText').value;
            payload.image = document.getElementById('customImage').value;
            payload.mediaUrl = document.getElementById('customMedia').value;
        }

        fetch('/api/add', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            if(currentMode==='link') document.getElementById('tweetUrl').value = '';
            else { document.getElementById('customTitle').value = ''; document.getElementById('customText').value = ''; }
        });
    }

    function api(endpoint, data) {
        fetch(endpoint === 'manage' ? '/api/manage' : '/api/control', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
    }

    function editItem(index, actionType, val) {
        fetch('/api/edit_tweet', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index, [actionType]: val })
        });
    }

    function openEdit(index, title, text) {
        document.getElementById('editIndex').value = index;
        document.getElementById('editTitle').value = title;
        document.getElementById('editText').value = text;
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
    function saveEdit() {
        const index = document.getElementById('editIndex').value;
        const newTitle = document.getElementById('editTitle').value;
        const newText = document.getElementById('editText').value;
        fetch('/api/edit_tweet', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index, newTitle, newText })
        }).then(() => closeEdit());
    }

    function updateSettings() {
        const settings = {
            showAvatar: document.getElementById('showAvatar').checked,
            showName: document.getElementById('showName').checked,
            showMedia: document.getElementById('showMedia').checked,
            showDate: document.getElementById('showDate').checked,
            playSound: document.getElementById('playSound').checked,
            defaultDuration: parseInt(document.getElementById('globalTimer').value) || 15
        };
        fetch('/api/settings', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(settings)
        });
    }
</script>
</body>
</html>