<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZairuDuo Studio ğŸ™ï¸</title>
    <style>
        body { background: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
        .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        @media (max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }

        input, select, button, textarea { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #222; color: white; margin: 5px 0; font-size: 14px; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .box { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .section-title { margin: 0 0 10px 0; font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { background: #333; color: #aaa; flex: 1; border-bottom: 2px solid transparent; border-radius: 6px 6px 0 0; }
        .tab-btn.active { background: #1d9bf0; color: white; border-bottom: 2px solid white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .btn-add { background: linear-gradient(45deg, #1d9bf0, #00ba7c); }
        .btn-control { background: #333; border: 1px solid #555; }
        .btn-active-auto { background: #00ba7c; color: white; animation: pulse 2s infinite; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ· */
        .tweet-item { background: #1e1e1e; padding: 8px; margin-bottom: 6px; border-radius: 6px; border-right: 4px solid #333; transition: all 0.3s; font-size: 13px; }
        .tweet-item.active { border-right-color: #1d9bf0; background: #252a30; }
        .tweet-item.pinned { border-right-color: #e6b800; }
        .tweet-item.breaking { border-right-color: #f91880; background: rgba(249, 24, 128, 0.1); }

        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; color: #888; font-size: 11px; }
        
        /* ğŸ”¥ ØªÙ‚Ù„ÙŠØµ Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ Ù„ÙŠØ£Ø®Ø° Ù…Ø³Ø§Ø­Ø© ØµØºÙŠØ±Ø© ğŸ”¥ */
        .item-content { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 100%; 
            color: #ddd; 
            font-weight: 500;
            margin-bottom: 6px;
        }

        .controls-row { display: flex; gap: 4px; }
        .mini-btn { padding: 4px 8px; font-size: 11px; width: auto; flex: 0; }
        .play-btn { flex: 1; background: #1d9bf0; color: white; }

        .preview-container { width: 100%; height: 168px; overflow: hidden; position: relative; background: #000; border-radius: 8px; border: 2px solid #333; }
        iframe { width: 1280px; height: 720px; border: none; transform: scale(0.234); transform-origin: top left; pointer-events: none; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        #editModalContent { background: #222; padding: 20px; border-radius: 10px; width: 400px; border: 1px solid #444; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="main-grid">
    <div>
        <div class="box" style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
            <div><span id="statusIcon">âšª</span> <span id="statusText">...</span></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <label style="font-size:12px;"><input type="checkbox" id="playSound" onchange="updateSettings()" style="width:auto;"> ğŸ”Š</label>
                <input type="number" id="globalTimer" value="15" style="width:50px; text-align:center; padding:5px;" onchange="updateSettings()" title="Ø§Ù„Ù…Ø¤Ù‚Øª">
            </div>
        </div>

        <div class="box" style="border-top: 3px solid #1d9bf0;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('link')">ğŸ”— Ø±Ø§Ø¨Ø·</button>
                <button class="tab-btn" onclick="switchTab('custom')">âœï¸ Ù…Ø®ØµØµ</button>
            </div>
            <div id="tab-link" class="tab-content active">
                <input type="text" id="tweetUrl" placeholder="https://x.com/..." autofocus>
            </div>
            <div id="tab-custom" class="tab-content">
                <input type="text" id="customTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                <textarea id="customText" rows="2" placeholder="Ø§Ù„Ù†Øµ..."></textarea>
                <input type="text" id="customImage" placeholder="ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <input type="text" id="customMedia" placeholder="Ù…ÙŠØ¯ÙŠØ§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <select id="addTheme" style="flex:1;">
                    <option value="classic">ÙƒÙ„Ø§Ø³ÙŠÙƒ</option>
                    <option value="minimal">Ù…ÙŠØªØ§Ù„ (Minimal)</option>
                    <option value="chunky">Ø¶Ø®Ù… (Chunky)</option>
                    <option value="bubble">ÙÙ‚Ø§Ø¹Ø©</option>
                </select>
                <input type="number" id="addDuration" placeholder="Ø«ÙˆØ§Ù†ÙŠ" style="width:60px; text-align:center;">
            </div>
            <button class="btn-add" onclick="addItem()">Ø¥Ø¶Ø§ÙØ© â•</button>
        </div>

        <h3 class="section-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (<span id="count">0</span>)</h3>
        <div id="queueList"></div>
    </div>

    <div>
        <div class="box">
            <h4 class="section-title">ğŸ‘ï¸ Live</h4>
            <div class="preview-container">
                <iframe src="/overlay.html" scrolling="no"></iframe>
            </div>
        </div>
        <div class="box">
            <h4 class="section-title">ğŸ® ØªØ­ÙƒÙ…</h4>
            <div style="display:flex; gap:5px;">
                <button class="btn-control" onclick="api('control', {action:'prev'})">â®ï¸</button>
                <button class="btn-control" onclick="api('control', {action:'next'})">â­ï¸</button>
            </div>
            <button id="btnAuto" class="btn-control" style="width:100%; margin-top:5px;" onclick="api('control', {action:'toggle_auto'})">ØªÙ„Ù‚Ø§Ø¦ÙŠ â¯ï¸</button>
            <button class="btn-control" style="width:100%; margin-top:5px; background:#f91880; color:white;" onclick="api('control', {action:'hide'})">Ø¥Ø®ÙØ§Ø¡ â¹ï¸</button>
        </div>
        <div class="box">
            <h4 class="section-title">âš™ï¸ Ø¥Ø¸Ù‡Ø§Ø±</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <label><input type="checkbox" id="showAvatar" onchange="updateSettings()" style="width:auto;"> ØµÙˆØ±Ø©</label>
                <label><input type="checkbox" id="showName" onchange="updateSettings()" style="width:auto;"> Ø§Ø³Ù…</label>
                <label><input type="checkbox" id="showMedia" onchange="updateSettings()" style="width:auto;"> Ù…ÙŠØ¯ÙŠØ§</label>
                <label><input type="checkbox" id="showDate" onchange="updateSettings()" style="width:auto;"> ØªØ§Ø±ÙŠØ®</label>
            </div>
        </div>
    </div>
</div>

<div id="editModal">
    <div id="editModalContent">
        <h3 style="margin-top:0;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
        <input type="hidden" id="editIndex">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ø§Ø³Ù…):</label>
        <input type="text" id="editTitle">
        <label>Ø§Ù„Ù†Øµ:</label>
        <textarea id="editText" rows="4"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="saveEdit()" style="background:#1d9bf0;">Ø­ÙØ¸</button>
            <button onclick="closeEdit()" style="background:#555;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let currentMode = 'link';

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchTab('${mode}')"]`).classList.add('active');
        document.getElementById(`tab-${mode}`).classList.add('active');
    }

    socket.on('state_update', (state) => {
        document.getElementById('count').innerText = state.queue.length;
        document.getElementById('statusText').innerText = state.isAuto ? "Auto" : "Manual";
        document.getElementById('statusIcon').innerText = state.isAuto ? "ğŸŸ¢" : "â¸ï¸";
        
        const btnAuto = document.getElementById('btnAuto');
        if(state.isAuto) btnAuto.classList.add('btn-active-auto'); else btnAuto.classList.remove('btn-active-auto');

        if(state.settings) {
            document.getElementById('showAvatar').checked = state.settings.showAvatar;
            document.getElementById('showName').checked = state.settings.showName;
            document.getElementById('showMedia').checked = state.settings.showMedia;
            document.getElementById('showDate').checked = state.settings.showDate;
            document.getElementById('playSound').checked = state.settings.playSound;
            document.getElementById('globalTimer').value = state.settings.defaultDuration || 15;
        }

        const list = document.getElementById('queueList');
        list.innerHTML = '';
        state.queue.forEach((t, i) => {
            const div = document.createElement('div');
            const isPinned = t.customSettings?.pinned;
            const isBreaking = t.customSettings?.breaking;
            
            div.className = `tweet-item ${i === state.current ? 'active' : ''} ${isPinned ? 'pinned' : ''} ${isBreaking ? 'breaking' : ''}`;
            
            // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… name Ø£Ùˆ custom title
            const displayTitle = t.user.name;
            const displayText = t.text || 'Ù…ÙŠØ¯ÙŠØ§';

            div.innerHTML = `
                <div class="item-header">
                    <span>#${i+1} â€¢ ${displayTitle}</span>
                    <span>${isPinned ? 'ğŸ“Œ' : ''} ${isBreaking ? 'ğŸš¨' : ''}</span>
                </div>
                <div class="item-content" title="${displayText}">${displayText}</div>
                <div class="controls-row">
                    <button class="mini-btn play-btn" onclick="api('control', {action:'show', index:${i}})">â–¶ï¸</button>
                    <button class="mini-btn" style="background:#444;" onclick="openEdit(${i}, '${displayTitle.replace(/'/g, "\\'")}', '${displayText.replace(/'/g, "\\'").replace(/\n/g, ' ')}')" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰">âœï¸</button>
                    <button class="mini-btn" style="background:${isPinned?'#e6b800':'#333'}" onclick="editItem(${i}, 'togglePin', true)" title="ØªØ«Ø¨ÙŠØª">ğŸ“Œ</button>
                    <button class="mini-btn" style="background:${isBreaking?'#f91880':'#333'}" onclick="editItem(${i}, 'toggleBreaking', true)" title="Ø¹Ø§Ø¬Ù„">ğŸš¨</button>
                    <button class="mini-btn" style="background:#f00;" onclick="api('manage', {action:'delete', index:${i}})">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(div);
        });
    });

    function addItem() {
        const theme = document.getElementById('addTheme').value;
        const duration = document.getElementById('addDuration').value;
        let payload = { mode: currentMode, theme, duration };

        if (currentMode === 'link') {
            payload.url = document.getElementById('tweetUrl').value;
        } else {
            payload.title = document.getElementById('customTitle').value;
            payload.text = document.getElementById('customText').value;
            payload.image = document.getElementById('customImage').value;
            payload.mediaUrl = document.getElementById('customMedia').value;
        }

        fetch('/api/add', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).then(() => {
            if(currentMode==='link') document.getElementById('tweetUrl').value = '';
            else { document.getElementById('customTitle').value = ''; document.getElementById('customText').value = ''; }
        });
    }

    function api(endpoint, data) {
        fetch(endpoint === 'manage' ? '/api/manage' : '/api/control', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        });
    }

    function editItem(index, actionType, val) {
        fetch('/api/edit_tweet', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index, [actionType]: val })
        });
    }

    // Modal Functions
    function openEdit(index, title, text) {
        document.getElementById('editIndex').value = index;
        document.getElementById('editTitle').value = title;
        document.getElementById('editText').value = text;
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
    function saveEdit() {
        const index = document.getElementById('editIndex').value;
        const newTitle = document.getElementById('editTitle').value;
        const newText = document.getElementById('editText').value;
        fetch('/api/edit_tweet', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index, newTitle, newText })
        }).then(() => closeEdit());
    }

    function updateSettings() {
        const settings = {
            showAvatar: document.getElementById('showAvatar').checked,
            showName: document.getElementById('showName').checked,
            showMedia: document.getElementById('showMedia').checked,
            showDate: document.getElementById('showDate').checked,
            playSound: document.getElementById('playSound').checked,
            defaultDuration: parseInt(document.getElementById('globalTimer').value) || 15
        };
        fetch('/api/settings', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(settings)
        });
    }
</script>
</body>
</html>