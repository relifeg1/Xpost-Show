<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>ØªØ­ÙƒÙ… ZairuDuo</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: #121212;
            color: white;
            margin: 0;
            padding: 15px;
            display: flex;
            gap: 15px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .column {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .queue-col {
            flex: 2;
        }

        .settings-col {
            flex: 1;
            min-width: 320px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .panel {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #333;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .panel-full {
            flex: 1;
            min-height: 0;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .queue-list {
            overflow-y: auto;
            flex: 1;
            margin-top: 10px;
            padding-left: 5px;
        }

        .tweet-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #252525;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 8px;
            height: 55px;
            flex-shrink: 0;
            border: 1px solid #333;
            position: relative;
        }

        .tweet-item.active {
            border: 2px solid #1d9bf0;
            background: #15202b;
        }

        /* Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ®ØµÙŠØµ */
        .custom-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f91880;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }

        .tweet-item.has-custom .custom-badge {
            display: block;
        }

        .t-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }

        .t-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .t-text {
            font-size: 0.8rem;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        button {
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Cairo';
            transition: 0.2s;
        }

        .btn-blue {
            background: #1d9bf0;
            color: white;
        }

        .btn-green {
            background: #00ba7c;
            color: white;
        }

        .btn-red {
            background: #f91880;
            color: white;
        }

        .btn-dark {
            background: #333;
            color: white;
        }

        .btn-icon {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ */
        .auto-active {
            background: #00ffaa !important;
            color: black !important;
            box-shadow: 0 0 15px rgba(0, 255, 170, 0.4);
        }

        /* Ø§Ù„Ø³ÙˆÙŠØªØ´ */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #1d9bf0;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
        }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
        #editModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            width: 350px;
            border: 1px solid #555;
        }
    </style>
</head>

<body>

    <div id="editModal">
        <div class="modal-content">
            <h3 style="margin-top:0">âœï¸ ØªØ®ØµÙŠØµ Ø§Ù„ØªØºØ±ÙŠØ¯Ø©</h3>
            <p style="font-size:0.8rem; color:#888;">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØªØºØ±ÙŠØ¯Ø© ÙÙ‚Ø·.</p>

            <div class="setting-row">
                <span>ÙˆÙ‚Øª Ø®Ø§Øµ (Ø«ÙˆØ§Ù†ÙŠ)</span>
                <input type="number" id="editDuration" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ø¹Ø§Ù…" style="width: 80px;">
            </div>
            <hr style="border-color:#333">
            <div class="setting-row">
                <span>ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø±Ø¶</span>
                <label class="switch"><input type="checkbox" id="editAvatar"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Ø§Ù„Ø§Ø³Ù…</span>
                <label class="switch"><input type="checkbox" id="editName"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Ø§Ù„Ù…ÙŠØ¯ÙŠØ§</span>
                <label class="switch"><input type="checkbox" id="editMedia"><span class="slider"></span></label>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-green" style="width:100%" onclick="saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ®ØµÙŠØµ</button>
                <button class="btn-red" style="width:100%" onclick="resetEdit()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ®ØµÙŠØµ</button>
            </div>
            <button class="btn-dark" style="width:100%; margin-top:10px" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="column queue-col">
        <div class="panel panel-full">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0;">ğŸ“œ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (<span id="count">0</span>)</h3>
                <div style="display:flex; gap:5px">
                    <button class="btn-dark" onclick="api('control', {action:'toggle_auto'})" id="btnAutoMain">â¯ï¸ ØªØ´ØºÙŠÙ„
                        Ø¢Ù„ÙŠ</button>
                    <button class="btn-red" onclick="api('manage', {action:'clear'})">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                </div>
            </div>
            <div class="queue-list" id="queueList"></div>
        </div>
    </div>

    <div class="column settings-col">
        <div class="panel">
            <h4>â• Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</h4>
            <div style="display:flex; gap:5px">
                <input type="text" id="urlInput" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØªØºØ±ÙŠØ¯Ø©..." style="margin:0">
                <button class="btn-blue" style="width:auto" onclick="addTweet()">+</button>
            </div>
            <button class="btn-dark" style="margin-top:5px" onclick="addFromClipboard()">Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©</button>
        </div>

        <div class="panel">
            <h4>ğŸŒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)</h4>
            <div class="setting-row">
                <span>â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø«ÙˆØ§Ù†ÙŠ)</span>
                <input type="number" id="defaultDuration" style="width:60px; text-align:center" onchange="saveGlobal()">
            </div>
            <hr style="border-color:#333; width:100%">

            <div class="setting-row">
                <span>Ø§Ù„ØµÙˆØ±Ø©</span> <label class="switch"><input type="checkbox" id="showAvatar"
                        onchange="saveGlobal()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Ø§Ù„Ø§Ø³Ù…</span> <label class="switch"><input type="checkbox" id="showName"
                        onchange="saveGlobal()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Ø§Ù„Ù…ÙŠØ¯ÙŠØ§</span> <label class="switch"><input type="checkbox" id="showMedia"
                        onchange="saveGlobal()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</span> <label class="switch"><input type="checkbox" id="showStats"
                        onchange="saveGlobal()"><span class="slider"></span></label>
            </div>
            <div class="setting-row">
                <span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span> <label class="switch"><input type="checkbox" id="showDate"
                        onchange="saveGlobal()"><span class="slider"></span></label>
            </div>

            <div class="setting-row" style="margin-top:10px">
                <span>ğŸ” Ø§Ù„Ø­Ø¬Ù…</span>
                <input type="range" id="scale" min="0.5" max="1.5" step="0.1" style="width:100px"
                    oninput="saveGlobal()">
            </div>
        </div>

        <div class="panel">
            <button class="btn-red" onclick="fetch('/hide')">Ø¥Ø®ÙØ§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ ğŸ‘ï¸â€ğŸ—¨ï¸</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentQueue = [];
        let editIndex = -1;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø§Ù…Ù„
        socket.on('state_update', (data) => {
            currentQueue = data.queue;
            renderQueue(data);
            renderSettings(data.settings);

            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
            const btn = document.getElementById('btnAutoMain');
            if (data.isAuto) {
                btn.innerText = "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¢Ù„ÙŠ";
                btn.classList.add('auto-active');
            } else {
                btn.innerText = "â¯ï¸ ØªØ´ØºÙŠÙ„ Ø¢Ù„ÙŠ";
                btn.classList.remove('auto-active');
            }
        });

        function renderQueue(data) {
            const list = document.getElementById('queueList');
            document.getElementById('count').innerText = data.queue.length;
            list.innerHTML = '';

            data.queue.forEach((t, i) => {
                const isCustom = t.customSettings || t.customDuration;
                const div = document.createElement('div');
                div.className = `tweet-item ${i === data.current ? 'active' : ''} ${isCustom ? 'has-custom' : ''}`;

                div.innerHTML = `
                    <div class="custom-badge">Ù…Ø®ØµØµ</div>
                    <img src="${t.user.profile_image_url_https}" class="t-img">
                    <div class="t-content">
                        <div style="font-weight:bold; font-size:0.85rem">${t.user.name}</div>
                        <div class="t-text">${t.text}</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="api('control', {action:'show', index:${i}})" class="btn-blue btn-icon" title="Ø¹Ø±Ø¶">â–¶ï¸</button>
                        <button onclick="openEdit(${i})" class="btn-dark btn-icon" title="ØªØ®ØµÙŠØµ">âš™ï¸</button>
                        <button onclick="api('manage', {action:'move_up', index:${i}})" class="btn-dark btn-icon">â¬†ï¸</button>
                        <button onclick="api('manage', {action:'move_down', index:${i}})" class="btn-dark btn-icon">â¬‡ï¸</button>
                        <button onclick="api('manage', {action:'delete', index:${i}})" class="btn-red btn-icon">âœ–ï¸</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderSettings(s) {
            document.getElementById('showAvatar').checked = s.showAvatar;
            document.getElementById('showName').checked = s.showName;
            document.getElementById('showMedia').checked = s.showMedia;
            document.getElementById('showStats').checked = s.showStats;
            document.getElementById('showDate').checked = s.showDate;
            document.getElementById('defaultDuration').value = s.defaultDuration;
            document.getElementById('scale').value = s.scale;
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ®ØµÙŠØµ ---
        function openEdit(index) {
            editIndex = index;
            const t = currentQueue[index];
            const modal = document.getElementById('editModal');

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            const settings = t.customSettings || {}; // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ØŒ ÙƒØ§Ø¦Ù† ÙØ§Ø±Øº (Ø³ÙŠØ£Ø®Ø° Ù‚ÙŠÙ… Ù…Ù† UI Ù„Ø§Ø­Ù‚Ø§Ù‹)

            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ù†Ø§ Ø³Ù†ÙØªØ±Ø¶ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ®ØµÙŠØµØŒ Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµÙŠØµ
            // Ø§Ù„Ø£ÙØ¶Ù„: Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªØ®ØµÙŠØµ
            document.getElementById('editDuration').value = t.customDuration || '';
            document.getElementById('editAvatar').checked = (t.customSettings ? t.customSettings.showAvatar : true);
            document.getElementById('editName').checked = (t.customSettings ? t.customSettings.showName : true);
            document.getElementById('editMedia').checked = (t.customSettings ? t.customSettings.showMedia : true);

            modal.style.display = 'flex';
        }

        function closeModal() { document.getElementById('editModal').style.display = 'none'; }

        async function saveEdit() {
            const customSettings = {
                showAvatar: document.getElementById('editAvatar').checked,
                showName: document.getElementById('editName').checked,
                showMedia: document.getElementById('editMedia').checked,
                // Ø¨Ù‚ÙŠØ© Ø§Ù„Ù‚ÙŠÙ… Ù†ØªØ±ÙƒÙ‡Ø§ true Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¹Ø¯Ù„Ù‡Ø§
                showStats: true, showDate: true, scale: parseFloat(document.getElementById('scale').value)
            };
            const customDuration = document.getElementById('editDuration').value ? parseInt(document.getElementById('editDuration').value) : null;

            await api('edit_tweet', { index: editIndex, customSettings, customDuration });
            closeModal();
        }

        async function resetEdit() {
            await api('edit_tweet', { index: editIndex, customSettings: null, customDuration: null });
            closeModal();
        }

        // --- APIs ---
        async function api(endpoint, body) {
            await fetch(`/api/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        }

        async function saveGlobal() {
            const settings = {
                showAvatar: document.getElementById('showAvatar').checked,
                showName: document.getElementById('showName').checked,
                showMedia: document.getElementById('showMedia').checked,
                showStats: document.getElementById('showStats').checked,
                showDate: document.getElementById('showDate').checked,
                defaultDuration: parseInt(document.getElementById('defaultDuration').value),
                scale: parseFloat(document.getElementById('scale').value)
            };
            await api('settings', settings);
        }

        async function addTweet() {
            const url = document.getElementById('urlInput').value;
            if (url) { await api('add', { url }); document.getElementById('urlInput').value = ''; }
        }
        async function addFromClipboard() { await api('add', {}); }
    </script>
</body>

</html>